<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cozy Book Diary â€” Word Cap + Scrolling Paper (with Login)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            :root {
                /* Light defaults */
                --bg: #fffaf3;
                --paper: #fffef8;
                --ink: #2b2b2b;
                --muted: #6b7280;
                --line: rgba(60, 100, 160, .18);
                --margin: rgba(220, 40, 70, .22);
                --shadow: 0 24px 64px rgba(0, 0, 0, .16);
                --btn: #111827;
                --btnText: #fff;
            }

            /* Dark theme when user toggles */
            :root[data-theme="dark"] {
                --bg: #0e1217;
                --paper: #0f141a;
                --ink: #e6edf3;
                --muted: #9aa4af;
                --line: rgba(120, 160, 220, .18);
                --margin: rgba(240, 90, 120, .28);
                --shadow: 0 24px 64px rgba(0, 0, 0, .38);
                --btn: #e6edf3;
                --btnText: #0e1217;
            }

            /* Follow system when no explicit toggle */
            @media (prefers-color-scheme: dark) {
                :root:not([data-theme="light"]) {
                    --bg: #0e1217;
                    --paper: #0f141a;
                    --ink: #e6edf3;
                    --muted: #9aa4af;
                    --line: rgba(120, 160, 220, .18);
                    --margin: rgba(240, 90, 120, .28);
                    --shadow: 0 24px 64px rgba(0, 0, 0, .38);
                    --btn: #e6edf3;
                    --btnText: #0e1217;
                }
            }

            * {
                box-sizing: border-box
            }

            html,
            body {
                height: 100%
            }

            body {
                margin: 0;
                background: var(--bg);
                color: var(--ink);
                font: 17px/1.6 "Georgia", "Garamond", ui-serif, system-ui, -apple-system, "Segoe UI", Roboto, serif;
                display: grid;
                place-items: center;
            }

            /* Login overlay */
            .login {
                position: fixed;
                inset: 0;
                z-index: 10;
                display: grid;
                place-items: center;
                padding: 16px;
                background:
                    radial-gradient(900px 600px at 10% 0%, color-mix(in oklab, var(--paper) 90%, transparent) 0%, transparent 60%),
                    radial-gradient(900px 600px at 90% 100%, color-mix(in oklab, var(--paper) 90%, transparent) 0%, transparent 60%),
                    var(--bg);
            }

            .card {
                width: 100%;
                max-width: 420px;
                background: var(--paper);
                border: 1px solid color-mix(in oklab, var(--ink) 8%, transparent);
                border-radius: 16px;
                box-shadow: 0 20px 60px color-mix(in oklab, #000 20%, transparent);
                padding: 20px;
                display: grid;
                gap: 12px;
            }

            .row {
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: space-between
            }

            .muted {
                color: var(--muted);
                font-size: 14px
            }

            input[type=password],
            input[type=text] {
                width: 100%;
                padding: 12px 14px;
                border: 1px solid color-mix(in oklab, var(--ink) 15%, transparent);
                border-radius: 12px;
                font: inherit;
                outline: none;
                background: var(--paper);
                color: var(--ink);
            }

            input:focus {
                border-color: color-mix(in oklab, var(--ink) 35%, transparent);
                box-shadow: 0 0 0 3px color-mix(in oklab, var(--ink) 18%, transparent)
            }

            .login button {
                appearance: none;
                border: none;
                background: var(--btn);
                color: var(--btnText);
                padding: 10px 14px;
                border-radius: 10px;
                cursor: pointer;
                font: 600 14px/1 ui-sans-serif, system-ui;
                box-shadow: 0 6px 16px color-mix(in oklab, #000 30%, transparent);
            }

            /* App shell */
            .wrap {
                width: min(920px, 100vw);
                height: 100vh;
                display: grid;
                place-items: center;
                padding: 12px;
            }

            .book {
                position: relative;
                width: 100%;
                height: 100%;
                border-radius: 16px;
                box-shadow: var(--shadow);
                background: var(--paper);
                overflow: hidden;
                display: grid;
                grid-template-rows: auto 1fr auto;
            }

            .topbar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                padding: 10px 12px;
                font-size: 14px;
                background: color-mix(in oklab, var(--paper) 90%, transparent);
                border-bottom: 1px solid color-mix(in oklab, var(--ink) 8%, transparent);
            }

            .controls {
                display: flex;
                gap: 8px
            }

            button {
                appearance: none;
                border: 1px solid color-mix(in oklab, var(--ink) 10%, transparent);
                background: color-mix(in oklab, var(--paper) 90%, transparent);
                color: var(--ink);
                padding: 8px 12px;
                border-radius: 10px;
                cursor: pointer;
                font: 600 14px/1 ui-sans-serif, system-ui;
                transition: transform .03s ease, box-shadow .2s ease, background .2s ease;
                box-shadow: 0 6px 16px color-mix(in oklab, #000 12%, transparent);
            }

            button:active {
                transform: translateY(1px)
            }

            .pill {
                background: color-mix(in oklab, var(--paper) 80%, transparent);
                border: 1px solid color-mix(in oklab, var(--ink) 10%, transparent);
                color: var(--ink);
                padding: 6px 10px;
                border-radius: 999px;
                font-weight: 600
            }

            /* Page layout: title | meta | editor | footer */
            .page {
                position: relative;
                margin: 8px 12px 12px;
                border-radius: 12px;
                border: 1px solid color-mix(in oklab, var(--ink) 8%, transparent);
                display: grid;
                grid-template-rows: auto auto 1fr auto;
                grid-template-areas:
                    "title"
                    "meta"
                    "body"
                    "bottom";
                overflow: hidden;
                background: var(--paper);
            }

            .title {
                grid-area: title;
                border: none;
                outline: none;
                background: transparent;
                width: 100%;
                margin: 0;
                padding: 10px 16px 2px 90px;
                font-size: 24px;
                line-height: 1.2;
                font-weight: 700;
                letter-spacing: .2px;
                color: var(--ink);
            }

            .meta {
                grid-area: meta;
                padding: 6px 16px 8px 90px;
                font-size: 13px;
                color: var(--muted);
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
                border-bottom: 1px solid color-mix(in oklab, var(--ink) 8%, transparent);
            }

            /* Scrollable writing surface; lined paper moves with scroll */
            .paper-body {
                grid-area: body;
                overflow: auto;
                padding: 2px 16px calc(14px + env(safe-area-inset-bottom)) 90px;
                background:
                    linear-gradient(90deg, transparent 0 72px, var(--margin) 72px 74px, transparent 74px 100%),
                    repeating-linear-gradient(180deg, transparent 0 32px, var(--line) 32px 33px),
                    var(--paper);
                background-attachment: local, local, local;
            }

            .content {
                min-height: auto;
                white-space: pre-wrap;
                outline: none;
                caret-color: #1b3a5a;
                font-size: 18px;
                line-height: 32px;
                color: var(--ink);
            }

            .content[contenteditable="false"] {
                user-select: text
            }

            .content[contenteditable][data-empty]:before {
                content: attr(placeholder);
                color: color-mix(in oklab, var(--muted) 80%, transparent)
            }

            /* Footer */
            .bottom {
                grid-area: bottom;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px 12px calc(12px + env(safe-area-inset-bottom));
                font-size: 13px;
                color: var(--muted);
                background: color-mix(in oklab, var(--paper) 90%, transparent);
                border-top: 1px solid color-mix(in oklab, var(--ink) 8%, transparent);
            }

            .page-num {
                font-variant-numeric: tabular-nums;
                letter-spacing: .02em
            }

            /* Floating Save stays above keyboard/safe area; JS will add extra kb offset */
            .fab-save {
                position: absolute;
                right: 16px;
                bottom: calc(16px + env(safe-area-inset-bottom));
                border: none;
                background: var(--btn);
                color: var(--btnText);
                border-radius: 999px;
                padding: 12px 16px;
                font: 600 14px/1 ui-sans-serif, system-ui;
                box-shadow: 0 10px 24px color-mix(in oklab, #000 35%, transparent);
                display: none;
            }

            .fab-save.show {
                display: block
            }

            /* Mobile refinements */
            @media (max-width: 480px) {
                .title {
                    padding-left: 70px;
                }

                .meta {
                    padding-left: 70px;
                }

                .paper-body {
                    padding-left: 70px;
                    background:
                        linear-gradient(90deg, transparent 0 55px, var(--margin) 55px 57px, transparent 57px 100%),
                        repeating-linear-gradient(180deg, transparent 0 30px, var(--line) 30px 31px),
                        var(--paper);
                    background-attachment: local, local, local;
                }

                .wrap {
                    padding: 0
                }

                .book {
                    border-radius: 0;
                    box-shadow: none
                }

                .topbar .brand {
                    display: none
                }
            }
        </style>
    </head>
    <body>

        <!-- Login overlay (new) -->
        <div id="login" class="login">
            <div class="card">
                <div class="row">
                    <div class="pill">Cozy Book</div>
                    <div class="muted">Enter password</div>
                </div>
                <input id="pass" type="password" placeholder="Password (any value works)" />
                <button id="enterBtn">Enter</button>
                <div class="muted">This is a dummy lock for UI testing only.</div>
            </div>
        </div>

        <!-- Original app -->
        <div class="wrap" id="app">
            <div class="book">
                <div class="topbar">
                    <div class="brand pill small">Cozy Book</div>
                    <div id="today"></div>
                    <div class="controls">
                        <button id="themeBtn" title="Toggle theme">Theme</button>
                        <button id="prevBtn">Prev</button>
                        <button id="newBtn">+</button>
                        <button id="nextBtn">Next</button>
                    </div>
                </div>

                <div class="page">
                    <input id="title" class="title" placeholder="Page titleâ€¦" maxlength="80" />
                    <div class="meta">
                        <span id="dateMeta">â€”</span>
                        <span>â€¢</span>
                        <label>Mood:
                            <select id="mood">
                                <option value="ðŸ˜Š">ðŸ˜Š</option>
                                <option value="ðŸ˜Œ">ðŸ˜Œ</option>
                                <option value="ðŸ¤”">ðŸ¤”</option>
                                <option value="ðŸ¥²">ðŸ¥²</option>
                                <option value="ðŸš€">ðŸš€</option>
                            </select>
                        </label>
                        <span id="lockState"></span>
                        <span id="wc" title="Words on this page">0w</span>
                    </div>
                    <div id="paperBody" class="paper-body">
                        <div id="content" class="content" contenteditable="plaintext-only" spellcheck="true"
                            placeholder="Write along the linesâ€¦"></div>
                    </div>
                    <button id="saveFab" class="fab-save">Save</button>
                    <div class="bottom">
                        <span id="status">Ready</span>
                        <span class="page-num" id="pager" title="Long-press to delete">1 / 1</span>
                    </div>
                </div>
            </div>
        </div>

        <script>
            /* ===== your original logic (unchanged) ===== */
            const WORDS_PER_PAGE = 400;
            const LS_KEY = "cozy-book-diary.v3";
            let pages = []; let i = 0;

            function load() { try { pages = JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch { pages = []; } if (!pages.length) pages.push(makePage("Welcome", "Write your first cozy page âœ¨", "ðŸ˜Š", false)); }
            function saveAll() { localStorage.setItem(LS_KEY, JSON.stringify(pages)); }
            function makePage(title = "", content = "", mood = "ðŸ˜Š", locked = false) { const now = Date.now(); return { id: crypto.randomUUID ? crypto.randomUUID() : "id_" + now, createdAt: now, updatedAt: now, title, content, mood, locked }; }

            const $ = s => document.querySelector(s);
            const titleEl = $("#title"); const contentEl = $("#content"); const moodEl = $("#mood");
            const pagerEl = $("#pager"); const dateMetaEl = $("#dateMeta"); const todayEl = $("#today");
            const statusEl = $("#status"); const lockStateEl = $("#lockState"); const saveFab = $("#saveFab"); const wcEl = $("#wc");
            const paperBodyEl = $("#paperBody");

            function fmt(ts) { return new Date(ts).toLocaleString(); }
            function setStatus(msg) { statusEl.textContent = msg; setTimeout(() => { if (statusEl.textContent === msg) statusEl.textContent = "Ready"; }, 1600); }

            function countWords(text) {
                if (window.Intl && Intl.Segmenter) { const seg = new Intl.Segmenter(navigator.language || "en", { granularity: "word" }); let n = 0; for (const s of seg.segment(text)) if (s.isWordLike) n++; return n; }
                return text.trim().split(/\s+/).filter(Boolean).length;
            }
            function cutoffIndexAtWord(text, limit) {
                if (window.Intl && Intl.Segmenter) { const seg = new Intl.Segmenter(navigator.language || "en", { granularity: "word" }); let n = 0, cut = text.length; for (const s of seg.segment(text)) { if (s.isWordLike) { n++; if (n === limit) { cut = s.index + s.segment.length; break; } } } return cut; }
                let seen = 0, idx = 0; const re = /(\S+|\s+)/g; for (const m of text.matchAll(re)) { const tok = m[0]; if (/\S/.test(tok)) { seen++; if (seen === limit) { idx = m.index + tok.length; break; } } } return idx || text.length;
            }

            function render() {
                const p = pages[i]; if (!p) return;
                titleEl.value = p.title || "";
                contentEl.textContent = p.content || "";
                moodEl.value = p.mood || "ðŸ˜Š";
                dateMetaEl.textContent = "Created " + new Date(p.createdAt).toDateString() + " â€¢ Updated " + fmt(p.updatedAt);
                pagerEl.textContent = (i + 1) + " / " + pages.length;
                lockStateEl.textContent = p.locked ? "Locked" : "Editing";
                setEditable(!p.locked);
                wcEl.textContent = countWords(p.content) + "w";
                toggleSave(false);
            }
            function setEditable(editable) {
                titleEl.readOnly = !editable; moodEl.disabled = !editable;
                contentEl.setAttribute("contenteditable", editable ? "plaintext-only" : "false");
            }
            function enforceWordCapAndSplit() {
                const p = pages[i]; if (!p || p.locked) return;
                const text = contentEl.textContent;
                const words = countWords(text);
                wcEl.textContent = words + "w";
                if (words <= WORDS_PER_PAGE) return;

                const cut = cutoffIndexAtWord(text, WORDS_PER_PAGE);
                const head = text.slice(0, cut).trimEnd();
                const tail = text.slice(cut).trimStart();

                p.title = titleEl.value.trim();
                p.content = head;
                p.mood = moodEl.value;
                p.updatedAt = Date.now();

                const newP = makePage("", tail, p.mood, false);
                pages.splice(i + 1, 0, newP);
                saveAll();

                render();
                i = i + 1;
                render();
                setStatus("Continued on new page");
            }
            function finalizeAllUpToCurrent() {
                const p = pages[i]; if (!p) return;
                if (!p.locked) {
                    p.title = titleEl.value.trim();
                    p.content = contentEl.textContent;
                    p.mood = moodEl.value;
                    p.updatedAt = Date.now();
                }
                const now = Date.now();
                for (let k = 0; k <= i; k++) {
                    if (!pages[k].locked) { pages[k].locked = true; pages[k].updatedAt = now; }
                }
                saveAll(); render(); toggleSave(false); setStatus("Saved and locked all pages so far");
            }
            function prev() { if (i > 0) { i--; render(); setStatus("Prev page"); } }
            function next() { if (i < pages.length - 1) { i++; render(); setStatus("Next page"); } }
            function addNew() {
                const mood = pages[i]?.mood || "ðŸ˜Š";
                pages.splice(i + 1, 0, makePage("", "", mood, false));
                i++;
                saveAll();
                render();
                setStatus("New page");
            }
            let pressTimer = null;
            function startDeletePress() {
                pressTimer = setTimeout(() => {
                    const p = pages[i]; if (!p) return;
                    const typed = prompt("Type DELETE to remove this page");
                    if (typed === "DELETE") {
                        if (p.locked && !confirm("This page is locked. Delete anyway?")) return;
                        pages.splice(i, 1);
                        if (i >= pages.length) i = Math.max(0, pages.length - 1);
                        if (!pages.length) { pages.push(makePage("", "", "ðŸ˜Š", false)); i = 0; }
                        saveAll(); render(); setStatus("Deleted");
                    } else { setStatus("Deletion cancelled"); }
                }, 1200);
            }
            function cancelDeletePress() { clearTimeout(pressTimer); pressTimer = null; }
            function toggleSave(show) { saveFab.classList.toggle("show", !!show); }
            function onAnyEdit() {
                const p = pages[i]; if (!p || p.locked) return;
                toggleSave(true);
                clearTimeout(onAnyEdit._t);
                onAnyEdit._t = setTimeout(() => {
                    p.title = titleEl.value.trim();
                    p.content = contentEl.textContent;
                    p.mood = moodEl.value;
                    p.updatedAt = Date.now();
                    wcEl.textContent = countWords(p.content) + "w";
                    saveAll();
                }, 350);
            }

            /* ===== Minimal login gate (new) ===== */
            const login = document.querySelector("#login");
            const pass = document.querySelector("#pass");
            const enterBtn = document.querySelector("#enterBtn");

            function bootApp() {
                todayEl.textContent = new Date().toDateString();
                load();
                render();

                // Wire controls (same as original DOMContentLoaded block)
                // Theme toggle: cycle light -> dark -> system
                const themeBtn = document.getElementById("themeBtn");
                function applyTheme(mode) { // "light" | "dark" | "system"
                    if (mode === "light") { document.documentElement.setAttribute("data-theme", "light"); }
                    else if (mode === "dark") { document.documentElement.setAttribute("data-theme", "dark"); }
                    else { document.documentElement.removeAttribute("data-theme"); } // follow prefers-color-scheme
                    localStorage.setItem("cozy.theme", mode);
                }
                themeBtn.addEventListener("click", () => {
                    const cur = localStorage.getItem("cozy.theme") || "system";
                    const next = cur === "system" ? "light" : cur === "light" ? "dark" : "system";
                    applyTheme(next);
                });
                applyTheme(localStorage.getItem("cozy.theme") || "system"); // init

                // Keep Save button and caret above virtual keyboard (Android/iOS)
                // Requires that the browser supports VisualViewport; otherwise no-op.
                const fab = document.getElementById("saveFab");
                function updateKB() {
                    const vv = window.visualViewport;
                    if (!vv) return;
                    // keyboard overlap height
                    const kb = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
                    fab.style.bottom = (16 + kb) + "px";                // lift FAB
                    // ensure caret stays visible while typing
                    const sel = window.getSelection();
                    if (sel && sel.rangeCount) {
                        const range = sel.getRangeAt(0).cloneRange(); range.collapse(true);
                        const rect = range.getBoundingClientRect();
                        const wrap = document.getElementById("paperBody").getBoundingClientRect();
                        const pad = 24 + kb;
                        if (rect.bottom > wrap.bottom - pad) {
                            document.getElementById("paperBody").scrollTop += (rect.bottom - (wrap.bottom - pad));
                        }
                        if (rect.top < wrap.top + 24) {
                            document.getElementById("paperBody").scrollTop -= ((wrap.top + 24) - rect.top);
                        }
                    }
                }
                if (window.visualViewport) {
                    visualViewport.addEventListener("resize", updateKB);
                    visualViewport.addEventListener("scroll", updateKB);
                }

                $("#prevBtn").addEventListener("click", prev);
                $("#nextBtn").addEventListener("click", next);
                $("#newBtn").addEventListener("click", addNew);
                saveFab.addEventListener("click", finalizeAllUpToCurrent);

                titleEl.addEventListener("input", onAnyEdit);
                moodEl.addEventListener("change", onAnyEdit);
                contentEl.addEventListener("input", () => { onAnyEdit(); enforceWordCapAndSplit(); });
                contentEl.addEventListener("paste", () => { setTimeout(() => { onAnyEdit(); enforceWordCapAndSplit(); }, 0); });

                pagerEl.addEventListener("mousedown", startDeletePress);
                pagerEl.addEventListener("mouseup", cancelDeletePress);
                pagerEl.addEventListener("mouseleave", cancelDeletePress);
                pagerEl.addEventListener("touchstart", (e) => { e.preventDefault(); startDeletePress(); }, { passive: false });
                pagerEl.addEventListener("touchend", cancelDeletePress);
            }

            document.addEventListener("DOMContentLoaded", () => {
                // Show login first; accept any password, including empty, for UI testing
                login.style.display = "grid";
                enterBtn.addEventListener("click", () => {
                    // dummy: any value works; require at least 1 char to avoid accidental enter
                    if ((pass.value || "").length >= 1) {
                        login.style.display = "none";
                        bootApp();
                    } else {
                        alert("Enter any password to continue (demo)");
                        pass.focus();
                    }
                });
            });
        </script>
    </body>
</html>